---
title: "Problem_Set_4"
author: "Amy Richardson"
date: "3/31/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Initiate packages
```{r}
library(tidyverse)
library(ggplot2)
library(cluster)
library(factoextra)
library(dendextend)
library(dplyr)
library(tidyr)
library(psych)
library(pastecs)
library(car)
library(ggpubr)
library(pgirmess)
```

Read in Data
```{r}
ts_df <- read.csv("VTNETSFinalv2.csv", header = TRUE)
```

In Transfer Data Set only keeping transfer from NVCC with a BS degree
```{r}
ts_df <- filter(ts_df, TransInst.Name == "Northern Va Cmty Coll-Annandal")
ts_df <- filter(ts_df, Eng.Bach.Flag == 1)
```

Remove Engineering Disciplines with n<20
```{r}
ts_df <- filter(ts_df, Eng.Major != "DOE")
ts_df <- filter(ts_df, Eng.Major != "OE")
ts_df <- filter(ts_df, Eng.Major != "MINE")
ts_df <- filter(ts_df, Eng.Major != "DAE")
ts_df <- filter(ts_df, Eng.Major != "BSE")
ts_df <- filter(ts_df, Eng.Major != "MSE")
ts_df <- filter(ts_df, Eng.Major != "CHE")
ts_df <- filter(ts_df, Eng.Major != "ISE")
ts_df <- filter(ts_df, Eng.Major != "ESM")

tsData_sub <- ts_df %>%
  select(Gender, NumberofCredits, Eng.Major, GPA, TotalSemesterTimetoDegree, FullTimeSemstoDegree) 
```

## Checking Data normality
Histograms 
```{r}
tsData_sub %>%
  ggplot(aes(x = NumberofCredits)) +
  geom_histogram () 
```

Histograms by Engineering Discipline
```{r}
tsData_sub %>%
  ggplot(aes(x = NumberofCredits, fill = Eng.Major)) +
  geom_histogram () +
  facet_grid(Eng.Major ~., scales = "free") 
```

Transfer Credit By Gender
```{r}
tsData_sub %>%
  ggplot(aes(x = NumberofCredits, fill = Gender)) +
  geom_histogram ()
  facet_grid(Eng.Major ~., scales = "free") 
```

Descriptive Statistics
```{r}
describe(ts_df$NumberofCredits)
by(ts_df$NumberofCredits, ts_df$Eng.Major, stat.desc)
```

Q-Q Plot of Transfer Credit
```{r}
qqplot.tsCredit <- qplot(sample = tsData_sub$NumberofCredits, stat="qq")
qqplot.tsCredit + stat_qq_line()+
  labs(title = "QQPlot for Transfer Credit", x = "Thoeretical", y = "Sample")
```
Q-Q plots by Major
```{r}
tsData_sub%>% 
  ggplot(aes(sample=NumberofCredits)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(Eng.Major ~ ., scales = "free")

```

Shappiro-Wilks Test
```{r}
shapiro.test(tsData_sub$NumberofCredits)
```
Since p < 0.05 the distribution of number of transfer credits is not normal

Plot boxplots of transfer credits by engineering discipline
```{r}
tsData_sub %>% 
  ggplot(aes(x = Eng.Major, y = NumberofCredits)) +
  geom_boxplot() +
  labs(title = "Boxplot of Transfer Credit  by Engineering Discipline",
       x ="Engineering Discipline",
       y = "Number of Transfer Credits") +
  theme(plot.title = element_text(hjust = 0.5))

```
Plot boxplots of transfer credits by gender
```{r}
tsData_sub %>% 
  ggplot(aes(x = Gender, y = NumberofCredits)) +
  geom_boxplot() +
  labs(title = "Boxplot of Transfer Credit  by Gender",
       x ="Gender",
       y = "Number of Transfer Credits") +
  theme(plot.title = element_text(hjust = 0.5))
```

## Checking Number of Semesters normality
```{r}
tsData_sub %>%
  ggplot(aes(x = TotalSemesterTimetoDegree)) +
  geom_histogram () 
```

Shappiro-Wilks Test
```{r}
shapiro.test(tsData_sub$TotalSemesterTimetoDegree)
```

Histogram by Engineering Discipline
```{r}
tsData_sub %>%
  ggplot(aes(x = NumberofCredits, fill = TotalSemesterTimetoDegree)) +
  geom_histogram () +
  facet_grid(Eng.Major ~., scales = "free") 
```

Plot boxplots of Total Semester to Degree by engineering discipline
```{r}
tsData_sub %>% 
  ggplot(aes(x = Eng.Major, y = TotalSemesterTimetoDegree)) +
  geom_boxplot() +
  labs(title = "Boxplot of Number of Semesters to Degree by Engineering Discipline",
       x ="Engineering Discipline",
       y = "Number of Semesters to Degree") +
  theme(plot.title = element_text(hjust = 0.5))

```
##Kruskal=Wallis Test
```{r}
kruskal.test(TotalSemesterTimetoDegree ~ Eng.Major, data = tsData_sub)
tsData_sub$Ranks<-rank(tsData_sub$TotalSemesterTimetoDegree)
by(tsData_sub$Ranks, tsData_sub$Eng.Major, mean)
```
Because p < 0.05 we can conclude that Engineering Major does significantly impact the number of semesters to degree.


Plot data
```{r}
ggplot(tsData_sub, aes(Eng.Major, TotalSemesterTimetoDegree)) + geom_boxplot() +
  labs(y = "Total Number of Semstesters after Transfer to Earn Degree", x = "Engineering Discipline")
```
Post Hoc tests
```{r}
kruskalmc(TotalSemesterTimetoDegree ~ Eng.Major, data = tsData_sub)
```

since none of the observations are greater than the critical difference

Could do more focused comparisons
```{r}
kruskalmc(TotalSemesterTimetoDegree ~ Eng.Major, data = tsData_sub, cont = 'two-tailed')
```


##Correlation Analaysis between Transfer Credits and Number of semesters to degree
```{r}
cor.test(tsData_sub$NumberofCredits, tsData_sub$TotalSemesterTimetoDegree, alternative = "less",  method="kendall")
```

Seaman's Correlation
```{r}
cor.test(tsData_sub$NumberofCredits, tsData_sub$TotalSemesterTimetoDegree, alternative = "less",  method="spearman")
```

##NYC Taxi Cab Data
```{r}
taxi_df <- read.csv("yellow_tripdata_2019-11.csv", header = TRUE)
zonei_df <- read.csv("taxi+_zone_lookup.csv", header = TRUE)

taxi_sub <- select(taxi_df, PULocationID, trip_distance, total_amount)

Loc_df <- merge(taxi_sub, zonei_df, by.x = "PULocationID", by.y = "LocationID")
Loc_df <- select(Loc_df, Zone, PULocationID, trip_distance, total_amount, Borough)
Loc_df <- filter(Loc_df, trip_distance > 0)
Loc_df<- filter(Loc_df, total_amount > 0 )

mean_df <- Loc_df %>% group_by(Zone) %>%
  summarise_at(vars(-PULocationID), funs(mean(., na.rm=TRUE)))

mean_df <- filter(mean_df, Zone != "NV")
```

Change Row Index to First Column
```{r}
mean_df2 <- mean_df[, -(1)]
rownames(mean_df2) <- mean_df$Zone
```


Can examine different number of groups
```{r}
k2 <- kmeans(mean_df2, centers = 2, nstart = 25)
k3 <- kmeans(mean_df2, centers = 3, nstart = 25)
k4 <- kmeans(mean_df2, centers = 4, nstart = 25)
k5 <- kmeans(mean_df2, centers = 5, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = mean_df2) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = mean_df2) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = mean_df2) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = mean_df2) + ggtitle("k = 5")

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)




```


Using Elbow Method to choose the optimum number of clusters [k]
```{r}
set.seed(123)

fviz_nbclust(mean_df2, kmeans, method = "wss")
```

Use Average Silhouette Method 
```{r}
fviz_nbclust(df, kmeans, method = "silhouette")
```


Gap Statistic Method
```{r}
set.seed(123)
gap_stat <- clusGap(mean_df2, FUN = kmeans, nstart = 25,
                    K.max = 10, B = 50)
fviz_gap_stat(gap_stat)
```


Extract Results
```{r}
set.seed(123)
final <- kmeans(mean_df2, 4, nstart = 25)
print(final)
```


Plot Final Groups
```{r}
fviz_cluster(final, data = mean_df2)
```

Find descriptive statistics for the 4 clusters
```{r}
mean_df2 %>%
  mutate(Cluster = final$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("mean")
```

Initial visulization
```{r}
distance <- get_dist(mean_df2)
fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
```

Add Cluster numbers in new Dataframe
```{r}
# Cluster Analysis - kmeans
k4_2 <- kmeans(mean_df2, centers = 4)
kmeans_basic_table <- data.frame(k4_2$size, k4_2$centers)
kmeans_basic_df <- data.frame(Cluster = k4_2$cluster, mean_df2)
# head of df
head(kmeans_basic_df)
```

Example ggplot
```{r}
ggplot(data = kmeans_basic_df, aes(y = Cluster)) +
  geom_bar(aes(fill = Cluster)) +
  ggtitle("Count of Clusters by Region") +
  theme(plot.title = element_text(hjust = 0.5))
```






##END








